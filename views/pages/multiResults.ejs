<!-- <%- include('../partials/head') %>
<%- include('../partials/navbar') %> -->

<div class="container my-4">
  <!-- Header -->
  <div class="mb-4">
    <a href="/screening" class="btn btn-outline-primary mb-3">
      <i class="fas fa-arrow-left"></i> Back to Screening
    </a>
    <h2 class="text-center">
      <i class="fas fa-search"></i> Multi-JD Screening Results
    </h2>
  </div>

  <!-- Summary Stats -->
  <div class="alert alert-info text-center mb-4">
    <h5>ðŸ“Š Screening Summary</h5>
    <p class="mb-0">
      Comprehensive candidate matching across multiple job categories<br>
      <strong>Found <%= (statistics && statistics.totalCandidates) ? statistics.totalCandidates : 0 %> candidates</strong>
      <% if (statistics && (statistics.averageBestScore || statistics.averageScore)) { %>
        with average best match: <strong><%= Math.round(statistics.averageBestScore || statistics.averageScore || 0) %>%</strong>
      <% } %>
    </p>
  </div>

  <% if (results && results.length > 0) { %>
    <!-- Results Grid -->
    <div class="row">
      <% results.forEach((candidate, index) => { %>
        <div class="col-lg-6 col-xl-4 mb-4">
          <div class="card h-100 candidate-result-card" style="border-left: 4px solid #007bff;">
            <div class="card-body">
              <!-- Rank and Name -->
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="card-title mb-0">
                  <i class="fas fa-user"></i> <%= candidate.candidateName || 'Unknown Candidate' %>
                </h5>
                <span class="badge bg-secondary">
                  #<%= candidate.displayRank || candidate.overallRank || (index + 1) %>
                </span>
              </div>

              <!-- Best Job Match - FIXED SCORING LOGIC -->
              <div class="mb-3">
                <h6 class="text-primary"><i class="fas fa-trophy"></i> Best Job Match</h6>
                <% 
                  // âœ… FIXED: Multiple fallback options for score
                  let displayScore = 0;
                  let jobTitle = 'No Match';
                  let jobCategory = 'unknown';

                  if (candidate.bestJobMatch) {
                    displayScore = candidate.bestJobMatch.score || 0;
                    jobTitle = candidate.bestJobMatch.jobTitle || 'Unknown Job';
                    jobCategory = candidate.bestJobMatch.category || 'unknown';
                  } else if (candidate.bestJobScore !== undefined) {
                    displayScore = candidate.bestJobScore;
                    jobTitle = candidate.bestJobTitle || 'Unknown Job';
                    jobCategory = candidate.bestJobCategory || 'unknown';
                  } else if (candidate.score !== undefined) {
                    displayScore = candidate.score;
                  } else if (candidate.matchScore !== undefined) {
                    displayScore = candidate.matchScore;
                  }

                  // âœ… ENSURE it's a number
                  displayScore = Math.round(Number(displayScore) || 0);
                %>
                
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-truncate me-2" title="<%= jobTitle %>">
                    <%= jobTitle %>
                  </span>
                  <span class="badge fs-6 <%= displayScore >= 80 ? 'bg-success' : displayScore >= 60 ? 'bg-warning' : 'bg-danger' %>">
                    <%= displayScore %>%
                  </span>
                </div>
                <small class="text-muted">
                  Category: <%= jobCategory.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) %>
                </small>
              </div>

              <!-- Contact Info -->
              <div class="mb-3">
                <% if (candidate.email) { %>
                  <div class="mb-1">
                    <small><i class="fas fa-envelope text-muted"></i> <%= candidate.email %></small>
                  </div>
                <% } %>
                <% if (candidate.phone) { %>
                  <div class="mb-1">
                    <small><i class="fas fa-phone text-muted"></i> <%= candidate.phone %></small>
                  </div>
                <% } %>
                <% if (candidate.experienceYears !== undefined) { %>
                  <div class="mb-1">
                    <small><i class="fas fa-briefcase text-muted"></i> <%= candidate.experienceYears %> years experience</small>
                  </div>
                <% } %>
              </div>

              <!-- All Job Scores -->
              <% if (candidate.multiJobScores || candidate.allJobScores) { %>
                <div class="mb-3">
                  <h6 class="text-secondary"><i class="fas fa-chart-bar"></i> All Job Scores</h6>
                  <div class="row g-1">
                    <% 
                      const jobScores = candidate.multiJobScores || candidate.allJobScores || {};
                      Object.entries(jobScores).forEach(([jobTitle, scoreData]) => {
                        const score = Math.round(scoreData.matchScore || scoreData.score || 0);
                    %>
                      <div class="col-6">
                        <div class="d-flex justify-content-between">
                          <small class="text-truncate" title="<%= jobTitle %>">
                            <%= jobTitle.length > 15 ? jobTitle.substring(0, 15) + '...' : jobTitle %>
                          </small>
                          <small class="badge <%= score >= 60 ? 'bg-success' : score >= 30 ? 'bg-warning' : 'bg-danger' %>">
                            <%= score %>%
                          </small>
                        </div>
                      </div>
                    <% }) %>
                  </div>
                </div>
              <% } %>

              <!-- Actions -->
              <div class="d-grid">
                <a href="/candidate/<%= candidate.resumeId || candidate._id %>" class="btn btn-primary btn-sm">
                  <i class="fas fa-eye"></i> View Full Profile
                </a>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <!-- No Results -->
    <div class="text-center py-5">
      <div class="alert alert-warning">
        <i class="fas fa-search fa-3x mb-3"></i>
        <h4>No Results Found</h4>
        <p>No candidates were processed in this multi-JD screening session.</p>
        <a href="/screening" class="btn btn-primary">
          <i class="fas fa-plus"></i> Start New Screening
        </a>
      </div>
    </div>
  <% } %>
</div>

<!-- <%- include('../partials/footer') %> -->
